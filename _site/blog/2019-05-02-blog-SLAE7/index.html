<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.1.1 <https://hydejack.com/>
--><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><title>Custom encrypter - One-time pad (OTP) | Silvia’s blog</title><meta name="generator" content="Jekyll v3.8.3" /><meta property="og:title" content="Custom encrypter - One-time pad (OTP)" /><meta name="author" content="Silvia Väli" /><meta property="og:locale" content="en" /><meta name="description" content="This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification. The task for 7/7 assignment is to create a custom crypter using any existing encryption schema. It can be written in any programming language of one’s choice." /><meta property="og:description" content="This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification. The task for 7/7 assignment is to create a custom crypter using any existing encryption schema. It can be written in any programming language of one’s choice." /><link rel="canonical" href="http://localhost:4000/blog/2019-05-02-blog-SLAE7/" /><meta property="og:url" content="http://localhost:4000/blog/2019-05-02-blog-SLAE7/" /><meta property="og:site_name" content="Silvia’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-05-02T00:00:00+03:00" /> <script type="application/ld+json"> {"datePublished":"2019-05-02T00:00:00+03:00","description":"This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification. The task for 7/7 assignment is to create a custom crypter using any existing encryption schema. It can be written in any programming language of one’s choice.","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/2019-05-02-blog-SLAE7/"},"url":"http://localhost:4000/blog/2019-05-02-blog-SLAE7/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/profile.jpg"},"name":"Silvia Väli"},"author":{"@type":"Person","name":"Silvia Väli"},"headline":"Custom encrypter - One-time pad (OTP)","dateModified":"2019-05-02T00:00:00+03:00","@context":"http://schema.org"}</script><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Silvia's blog"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="application-name" content="Silvia's blog"><meta name="msapplication-config" content="/assets/ieconfig.xml"><meta name="theme-color" content="rgb(25,55,71)"><meta name="generator" content="Hydejack v8.1.1" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Silvia's blog" /><link rel="alternate" href="http://localhost:4000/blog/2019-05-02-blog-SLAE7/" hreflang="en"><link rel="shortcut icon" href="/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/assets/icons/icon.png"><link rel="manifest" href="/assets/manifest.json"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="dns-prefetch" href="/" id="_baseURL"><link rel="dns-prefetch" href="/assets/js/hydejack-8.1.1.js" id="_hrefJS"><link rel="dns-prefetch" href="/sw.js" id="_hrefSW"><link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS"><link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG"> <script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); </script> <script>!function(w, d) { w._noPushState = false; w._noDrawer = false; /**/ loadJS(d.getElementById('_hrefFFO').href, function() { if ('Promise' in w) Promise.all([ new FontFaceObserver('Noto Sans').load(), new FontFaceObserver('Roboto Slab').load(), ]).then(function f() { d.body.classList.add('font-active'); }, function() {}); }); /**/ }(window, document);</script> <!--[if gt IE 8]><!----><link rel="stylesheet" href="/assets/css/hydejack-8.1.1.css"><link rel="stylesheet" href="/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:400|Noto+Sans:400,400i,700,700i"> <noscript><style> html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }</style></noscript><style id="_pageStyle"> .content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}</style><!--<![endif]--><body><div id="_navbar" class="navbar fixed-top"><div class="content"><div class="nav-btn-bar"> <span class="sr-only">Jump to:</span> <a id="_menu" class="nav-btn no-hover fl" href="#_navigation"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a></div></div></div><hr class="sr-only" hidden /> <hy-push-state replace-ids="_main" link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)" duration="250" script-selector="script:not([type^='math/tex'])" prefetch ><main id="_main" class="content fade-in layout-post" role="main" data-color="rgb(79,177,186)" data-theme-color="rgb(25,55,71)" data-image="/assets/img/sidebar-bg.jpg" data-overlay ><article id="post-blog-blog-SLAE7" class="page post mb6" role="article"><header><h1 class="post-title"> Custom encrypter - One-time pad (OTP)</h1><p class="post-date heading"> <time datetime="2019-05-02T00:00:00+03:00">02 May 2019</time> in <a href="/blog/" class="flip-title">Blog</a><div class="hr pb0"></div></header><p>This blog post has been created for completing the requirements of the <a href="https://www.pentesteracademy.com/course?id=7">SecurityTube Linux Assembly Expert Certification</a>. The task for 7/7 assignment is to create a custom crypter using any existing encryption schema. It can be written in any programming language of one’s choice.<p><b>Student ID</b>: SLAE64 - 1594<h3 id="custom-encrypter---one-time-pad">Custom encrypter - one time pad</h3><hr /><p>The encryption routine I chose for this assignment is the <strong>One-time pad (OTP)</strong>, which for it to work, needs a pre-shared key. The need for a pre-shared key in order to decrypt the payload is unfortunately one of the problems coming up when talking about the OTP. If the key sharing is not done securely, there is no point of using one-time pads in the first place. As this write-up won’t touch the topic of key sharing one bit, I assume one should come up with idea to share it securely outside the bounds of this little article.<p>The simple idea behind using a one-time pad can be described with a small example. If we have plain text <strong>a</strong>, and we have securely pre-shared a secret key <strong>b</strong>, then to have an encrypted text we would xor <strong>a</strong> and <strong>b</strong>. In order to decrypt the message we would use the pre-shared key <strong>b</strong> again to xor it with the encrypted text instead. In such a way we would end up again with the original text <strong>a</strong>. The following scheme describes the exact same steps taken:<p>
  <hy-img root-margin="512px"  src="/assets/img/SLAE/encrypter.png" alt="" >
    <noscript><img data-ignore  src="/assets/img/SLAE/encrypter.png" alt="" /></noscript>
    <span class="loading" slot="loading" hidden>
      <span class="icon-cog"></span>
    </span>
  </hy-img><h4 id="random-key-generation">Random key generation</h4><p>How do you create a key that is truely random? This is another problem aside from sharing the key itself. This is the moment, where if you would start looking around in the Internet, you would stumble upon pseudo-random number generators and true random number generators. Since I made up my mind that I would be using Python for this assignment, I decided to look what this language has to offer me out of the box and ended up using the <code class="highlighter-rouge">urandom()</code> function from the <code class="highlighter-rouge">os</code> module. I made this choice following Python’s own suggestions at generating pseudo-random numbers <a href="https://docs.python.org/2/library/random.html">1</a> page where they state:<br /><p><em>“Warning The pseudo-random generators of this module should not be used for security purposes. Use os.urandom() or SystemRandom if you require a cryptographically secure pseudo-random number generator.”</em><p>Another thing with one-time pad is that the key can be the same length as the payload or longer. I decided to keep it the same length with the payload itself.<h4 id="encryption">Encryption</h4><p>So finally the encryption routine ended up pretty short and simple, but as I decided to use Python 3 instead of 2 (nice experience for the future), it took me a little while. As os.urandom creates a random string of specified length and key[i] would give its decimal representation I could directly use it in xor. On the otherhand plaintext[i] would still need the ord() function applied in order to return an integer instead of an ascii char. The result of the xor operation still needed some formating as results like <code class="highlighter-rouge">0b</code> would by default be displayed just <code class="highlighter-rouge">b</code> in the final encrypted string. The formating here was important as I wanted to have the encrypted payload exactly the same length as the original payload. In this case, 43 bytes.<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import os, codecs

def encrypt(plaintext, key):
	print ("[+] -------- Encryption --------")
	print ("[+] Key: "+str(codecs.encode(key, 'hex')))
	encrypted = ""

	for i in range(len(plaintext)):
		c = ord(plaintext[i]) ^ key[i]
		d = "{:02x}".format(c)
		#print ("i:"+str(i)+" P: "+str(plaintext[i])+" K: "+str(key[i])+" C:"+str(c)+" D:"+str(d))
		encrypted += d

	print ("[+] Encrypted string: "+encrypted)
	return encrypted

plaintext = """\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08
\x48\x89\xd9\x51\x48\x89\xe7\x52\x48\x83\xec\x08\x48\x89\x3c\x24\x48
\x89\xe6\x48\x31\xc0\xb0\x3b\x0f\x05"""
key = os.urandom(len(plaintext))
encrypted = encrypt(plaintext,key)
</code></pre></div></div><p>The final output would look as follows (python3 ./program.py encrypt payload)<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 encrypt.py
[+] -------- Encryption --------
[+] Key: b'81a6b9cc11b37a5ce9d32ed80bdd18393eb275088b5bff05befe12ccff9d58613b597a5e5d002401d0ee73'
[+] Encrypted string: c9976b84aa9c553e80bd01ab6395d9d236fafcd1da1376e2ecb69120f7d5d15d1f11f3b81531e4b1ebe176
</code></pre></div></div><h4 id="decryption">Decryption</h4><p>For the decryption I needed my code to perform the same xor operation again, but on the encrypted payload with the shared key.<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import codecs

def decrypt(encrypted, key):
	print ("[+] -------- Decryption --------")
	decrypted = ""
	msg = codecs.decode(encrypted, 'hex')

	for i in range(len(msg)):
		c =  msg[i] ^ key[i]
		d = "{:02x}".format(c)
		decrypted += d

	print ("[+] Decrypted string (XX): \n"+decrypted)
	print("[+] Decrypted string (\\xXX):\n" + r"\x" + r"\x".join(decrypted[n : n+2] for n in range(0, len(decrypted), 2)))

encrypted = "ad15b360f30576bb4a0a75476da68ad1d287c22c078ad2b71929cb3de177e13fdea4a0ff4441e94195222e"
key = "e5246128482a59d923645a3405ee4b3adacf4bf556c25b504b6148d1e93f6803faec29190c7029f1ae2d2b"

decrypt(encrypted, codecs.decode(key, 'hex'))
</code></pre></div></div><p>The final output would look as follows, so we end up with our initial plaintext payload:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ python3 decrypt.py
[+] -------- Decryption --------
[+] Decrypted string (XX):
4831d248bb2f2f62696e2f736848c1eb084889d9514889e7524883ec0848893c244889e64831c0b03b0f05
[+] Decrypted string (\xXX):
\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x48\x89\xd9\x51\x48
\x89\xe7\x52\x48\x83\xec\x08\x48\x89\x3c\x24\x48\x89\xe6\x48\x31\xc0\xb0\x3b\x0f\x05
</code></pre></div></div><p>Link to source code in Github: <a href="https://github.com/silviavali/SLAE/blob/master/task7/encrypter.py">encrypter</a> and <a href="https://github.com/silviavali/SLAE/blob/master/task7/decrypter.py">decrypter</a><h4 id="related-posts">Related posts:</h4><ul><li><a href="https://silviavali.github.io/blog/2019-01-15-blog-SLAE1/">64-bit bindshell with a passphrase protection</a><li><a href="https://silviavali.github.io/blog/2019-01-25-blog-SLAE2/">64-bit reverse shell with passphrase protection</a><li><a href="https://silviavali.github.io/blog/2019-02-25-blog-SLAE3/">Egghunter (64-bit Linux) using access() syscall</a><li><a href="https://silviavali.github.io/blog/2019-02-25-blog-SLAE4/">Writing a 64-bit custom encoder (reversed byte order of 4 byte chunks)</a><li><a href="https://silviavali.github.io/blog/2019-05-01-blog-SLAE51/">Msfvenom generated Exec shellcode analysis - exec shellcode</a><li><a href="https://silviavali.github.io/blog/2019-05-01-blog-SLAE52/">Msfvenom generated bind_tcp shellcode analysis</a><li><a href="https://silviavali.github.io/blog/2019-05-01-blog-SLAE53/">Msfvenom generated shell_reverse_tcp payload</a><li><a href="https://silviavali.github.io/blog/2019-05-01-blog-SLAE6/">Polymorphic shellcodes for samples taken from Shell-Storm</a><li><a href="https://silviavali.github.io/blog/2019-05-01-blog-SLAE7/">Custom encrypter - One-time pad (OTP)</a></ul></article><hr class="dingbat related" /><aside class="about related mt4 mb4" role="complementary"><div class="author mt4"> <hy-img src="/assets/img/profile.jpg" class="avatar" alt="Silvia Väli" root-margin="512px" > <noscript><img data-ignore src="/assets/img/profile.jpg" class="avatar" alt="Silvia Väli" /></noscript> <span class="loading" slot="loading" hidden> <span class="icon-cog"></span> </span> </hy-img><h2 class="page-title hr"> About</h2><p>My name is Silvia. This blog just contains various things that interest me, but probably relatively more assembly stuff. I count myself quite new to the ITsec community as I am only 2 years in.<div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/silviavaliSV" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/silviavali" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a></ul></div></div></aside><aside class="related mb4" role="complementary"><h2 class="hr">Related Posts</h2><ul class="related-posts"><li> <a href="/blog/2019-05-01-blog-SLAE6/" class="h4 flip-title"> <span>Polymorphic shellcodes for samples taken from Shell-Storm</span> </a> <time class="heading faded fine" datetime="2019-05-01T00:00:00+03:00">01 May 2019</time><li> <a href="/blog/2019-05-01-blog-SLAE53/" class="h4 flip-title"> <span>Msfvenom generated shell_reverse_tcp payload</span> </a> <time class="heading faded fine" datetime="2019-05-01T00:00:00+03:00">01 May 2019</time><li> <a href="/blog/2019-05-01-blog-SLAE52/" class="h4 flip-title"> <span>Msfvenom generated bind_tcp shellcode analysis</span> </a> <time class="heading faded fine" datetime="2019-05-01T00:00:00+03:00">01 May 2019</time></ul></aside><footer role="contentinfo"><hr/><p><small class="copyright">© 2019. All rights reserved. </small><p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.1.1</span></small><hr class="sr-only"/></footer></main><hy-drawer class="" align="left" threshold="10" touch-events prevent-default ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(25,55,71);background-image:url(/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/" tabindex="-1"> <img src="/assets/img/profile.jpg" class="avatar" alt="Silvia's blog" data-ignore /> </a><h2 class="h1"><a href="/">Silvia's blog</a></h2><p class=""> Random notes or stuff I am curious about.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_navigation" href="/blog/" class="sidebar-nav-item active" > Blog </a><li> <a href="/about/" class="sidebar-nav-item" > About </a><li> <a href="/cheatsheet/" class="sidebar-nav-item" > Notes for TalTech A&D course </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/silviavaliSV" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/silviavali" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if !IE]><!----> <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script> <!--<![endif]--> <script>!function(w, d) { w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date; /**/ ga('create', 'UA-137562580-1', 'auto'); /**/ var pushStateEl = d.getElementsByTagName('hy-push-state')[0]; var timeoutId; pushStateEl.addEventListener('hy-push-state-load', function() { w.clearTimeout(timeoutId); timeoutId = w.setTimeout(function() { ga('set', 'page', w.location.pathname); ga('send', 'pageview'); }, 500); }); d.addEventListener('hy--cookies-ok', function () { w.ga(function(tracker) { w.ga("set", "anonymizeIp", undefined); localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId")); }); }); w.loadJSDeferred('https://www.google-analytics.com/analytics.js'); }(window, document);</script> <script> if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); } </script><h2 class="sr-only" hidden>Templates (for web app):</h2><template id="_animation-template" hidden><div class="animation-main fixed-top"><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template" hidden><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template" hidden><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_back-template" hidden> <a id="_back" class="back nav-btn fl no-hover"> <span class="sr-only">Back</span> <span class="icon-arrow-left2"></span> </a> </template> <template id="_permalink-template" hidden> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="icon-link"></span> </a> </template></html>
