<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v8.1.1 <https://hydejack.com/>
--><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><title>Notes for TalTech A&amp;D course | Silvia’s blog</title><meta name="generator" content="Jekyll v3.8.3" /><meta property="og:title" content="Notes for TalTech A&amp;D course" /><meta name="author" content="Silvia Väli" /><meta property="og:locale" content="en" /><meta name="description" content="Random notes or stuff I am curious about." /><meta property="og:description" content="Random notes or stuff I am curious about." /><link rel="canonical" href="http://localhost:4000/cheatsheet/" /><meta property="og:url" content="http://localhost:4000/cheatsheet/" /><meta property="og:site_name" content="Silvia’s blog" /><meta property="og:image" content="http://localhost:4000/assets/img/blog/hydejack-8.png" /> <script type="application/ld+json"> {"description":"Random notes or stuff I am curious about.","@type":"WebPage","image":"http://localhost:4000/assets/img/blog/hydejack-8.png","url":"http://localhost:4000/cheatsheet/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/profile.jpg"},"name":"Silvia Väli"},"author":{"@type":"Person","name":"Silvia Väli"},"headline":"Notes for TalTech A&amp;D course","@context":"http://schema.org"}</script><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Silvia's blog"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="application-name" content="Silvia's blog"><meta name="msapplication-config" content="/assets/ieconfig.xml"><meta name="theme-color" content="rgb(25,55,71)"><meta name="generator" content="Hydejack v8.1.1" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Silvia's blog" /><link rel="alternate" href="http://localhost:4000/cheatsheet/" hreflang="en"><link rel="shortcut icon" href="/assets/icons/favicon.ico"><link rel="apple-touch-icon" href="/assets/icons/icon.png"><link rel="manifest" href="/assets/manifest.json"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="dns-prefetch" href="/" id="_baseURL"><link rel="dns-prefetch" href="/assets/js/hydejack-8.1.1.js" id="_hrefJS"><link rel="dns-prefetch" href="/sw.js" id="_hrefSW"><link rel="dns-prefetch" href="/assets/bower_components/fontfaceobserver/fontfaceobserver.standalone.js" id="_hrefFFO"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.js" id="_hrefKatexJS"><link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_hrefKatexCSS"><link rel="dns-prefetch" href="/assets/img/swipe.svg" id="_hrefSwipeSVG"> <script>!function(e,t){"use strict";function n(e,t,n,r){e.addEventListener?e.addEventListener(t,n,r):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,r){var o=t.createElement("script");o.src=e,r&&n(o,"load",r,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(o,a),o},e._loaded=!1,e.loadJSDeferred=function(r,o){function a(){e._loaded=!0,o&&n(d,"load",o,{once:!0});var r=t.scripts[0];r.parentNode.insertBefore(d,r)}var d=t.createElement("script");return d.src=r,e._loaded?a():n(e,"load",a,{once:!0}),d},e.setRel=e.setRelStylesheet=function(e){function n(){this.rel="stylesheet"}var r=t.getElementById(e);r.addEventListener?r.addEventListener("load",n,{once:!0}):r.onload=n}}(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); </script> <script>!function(w, d) { w._noPushState = false; w._noDrawer = false; /**/ loadJS(d.getElementById('_hrefFFO').href, function() { if ('Promise' in w) Promise.all([ new FontFaceObserver('Noto Sans').load(), new FontFaceObserver('Roboto Slab').load(), ]).then(function f() { d.body.classList.add('font-active'); }, function() {}); }); /**/ }(window, document);</script> <!--[if gt IE 8]><!----><link rel="stylesheet" href="/assets/css/hydejack-8.1.1.css"><link rel="stylesheet" href="/assets/icomoon/style.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:400|Noto+Sans:400,400i,700,700i"> <noscript><style> html { font-family: Noto Sans, Helvetica, Arial, sans-serif!important; } h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6, .heading { font-family: Roboto Slab, Helvetica, Arial, sans-serif!important; }</style></noscript><style id="_pageStyle"> .content a:not(.btn){color:#4fb1ba;border-color:rgba(79,177,186,0.2)}.content a:not(.btn):hover{border-color:#4fb1ba}:focus{outline-color:#4fb1ba !important}.btn-primary{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:focus,.btn-primary.focus,.form-control:focus,.form-control.focus{box-shadow:0 0 0 3px rgba(79,177,186,0.5)}.btn-primary:hover,.btn-primary.hover{color:#fff;background-color:#409ba3;border-color:#409ba3}.btn-primary:disabled,.btn-primary.disabled{color:#fff;background-color:#4fb1ba;border-color:#4fb1ba}.btn-primary:active,.btn-primary.active{color:#fff;background-color:#409ba3;border-color:#409ba3}::selection{color:#fff;background:#4fb1ba}::-moz-selection{color:#fff;background:#4fb1ba}</style><!--<![endif]--><body><div id="_navbar" class="navbar fixed-top"><div class="content"><div class="nav-btn-bar"> <span class="sr-only">Jump to:</span> <a id="_menu" class="nav-btn no-hover fl" href="#_navigation"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a></div></div></div><hr class="sr-only" hidden /> <hy-push-state replace-ids="_main" link-selector="a[href]:not([href*='/assets/']):not(.external):not(.no-push-state)" duration="250" script-selector="script:not([type^='math/tex'])" prefetch ><main id="_main" class="content fade-in layout-about" role="main" data-color="rgb(79,177,186)" data-theme-color="rgb(25,55,71)" data-image="/assets/img/sidebar-bg.jpg" data-overlay ><article class="page" role="article"><header><h1 class="page-title">Notes for TalTech A&D course</h1><div class="hr pb0"></div></header><p><a href="/cheatsheet/#gdb-reference">GDB reference</a><br /><p>Exercises:<ul><li><a href="/cheatsheet/#hello-world-in-data-section">Hello World! in .data section</a><li><a href="/cheatsheet/#hello-world-jcp-technique">Hello World! JCP technique</a><li><a href="/cheatsheet/#execve">Execve</a><li><a href="/cheatsheet/#buffer-overflow">Buffer overflow</a></ul><p>Homework:<ul><li><a href="/cheatsheet/#homework">Homework</a> - deadline 1st of December, 23:59</ul><h2 id="gdb-reference"><a href="#gdb-reference">GDB reference</a></h2><table><thead><tr><th>Command<th>Description<tbody><tr><td>gdb ./file<td>open file <code class="highlighter-rouge">&lt;file&gt;</code> in gdb<tr><td>break main<td>break at function eg. <code class="highlighter-rouge">&lt;main&gt;</code><tr><td>break *0x40056a<td>break at address<tr><td>run<td>start debugging<tr><td>si/stepi<td>step into (eg. step into function)<tr><td>ni/nexti<td>step over (does not enter function, steps over it)<tr><td>info breakpoints<td>examine breakpoints<tr><td>p $rbp<td>print the value of $rbp<tr><td>p $rbp-0x8<td>print the value of $rbp-0x8<tr><td>x/x $rbp<td>print the value in hex at $rbp<tr><td>x/x 0x7fffffffdda8<td>print the value in hex at address<tr><td>x/i $rbp<td>print the assembly instructions at address<tr><td>x/8bx $rbp-0x28<td>display 8 bytes in hex beginning from address at $rbp-0x28</table><h2 id="hello-world-in-data-section"><a href="#hello-world-in-data-section">Hello World! in data section</a></h2><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>; ssize_t write(int fd, const void *buf, size_t count);
; Write a program which displays Hello World

;STEP 1 - global directive, program entry point, sections
global _start:
section .text

_start:
;STEP 2 - fd needs to be set to 1 (stdout)
	mov dil, 0x1

;STEP 3 - pointer to a buffer needs to point to a string we want to print to the stdout
	mov rsi, message
;STEP 4 - count needs to be set to number of bytes we want to print to stdout "Hello World!" + new line = 13 dec or 0xd in hex
	add rdx, 0xd

;STEP 5 - RAX needs to hold the syscall number we want to execute, call syscall
	add rax, 0x1
	syscall

;STEP 6 - exit() syscall
	xor rdi, rdi
	mov al, 0x3c
	syscall

section .data
	message: db 'Hello World!', 0xa
</code></pre></div></div><h2 id="hello-world-jcp-technique"><a href="#hello-world-jcp-technique">Hello World JCP technique</a></h2><p>2.1 with NULL bytes<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>; JMP-CALL-POP technique
; Write a program to display Hello World!
; 0xa - creates a new line character after the Hello World! string
; remove null bytes

global _start
section .text

_start:

	jmp callshell

shellcode:
	pop rsi
	mov rdx, 0xd
	add rdi, 1

	mov rax, 0x1
	syscall

exit:
	mov rax, 0x3c
	syscall

callshell:
	call shellcode

msg: db 'Hello World!', 0xa

</code></pre></div></div><p>2.2 without NULL bytes, but it doesn’t work in our test shellcode program, why? Find out in GDB, that some registers do not have expected values before the 1st syscall is executed.<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>; JMP-CALL-POP technique
; Write a program to display Hello World!
; 0xa - creates a new line character after the Hello World! string
; remove null bytes

global _start
section .text

_start:

	jmp callshell

shellcode:
	pop rsi
	mov dl, 0xd
	add dil, 1

	mov al, 0x1
	syscall

exit:
	mov al, 0x3c
	syscall

callshell:
	call shellcode

msg: db 'Hello World!', 0xa

</code></pre></div></div><p>2.3 Final shellcode using JCP technique:<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>; JMP-CALL-POP technique
; Write a program to display Hello World!
; 0xa - creates a new line character after the Hello World! string
; remove null bytes

global _start
section .text

_start:

	jmp callshell

shellcode:
	pop rsi
	xor rdx, rdx
	mov dl, 0xd

	xor rdi, rdi
	add rdi, 1

	xor rax, rax
	mov al, 0x1
	syscall

exit:
	mov al, 0x3c
	syscall

callshell:
	call shellcode

msg: db 'Hello World!', 0xa
</code></pre></div></div><h2 id="execve"><a href="#execve">Execve</a></h2><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global _start
section .text

_start:
	; int execve(const char *filename, char *const argv[],
        ; char *const envp[]);

	mov rbx, 0x68732f6e69622f2f
	xor rdx, rdx
	push rdx
	push rbx
	mov rdi, rsp

	push rdx
	push rdi
	mov rsi, rsp

	;syscall
	xor rax, rax
	mov al, 0x3b
	syscall
</code></pre></div></div><h2 id="buffer-overflow"><a href="#bof">Buffer overflow</a></h2><p><strong>Disable ASLR:</strong><br /> <code class="highlighter-rouge">echo 0 | sudo tee /proc/sys/kernel/randomize_va_space</code><p><strong>Compile the file</strong><br /> <code class="highlighter-rouge">gcc -fno-stack-protector -z execstack buffer.c -o buffer</code><p>Commands:<br /><ul><li>nasm -felf64 shellcode.nasm -o shellcode.o<li>ld shellcode.o -o shellcode<li>gethex shellcode<li>in GDB to calculate the number of bytes between 2 addresses <code class="highlighter-rouge">p/d 0xXXXXXXX-0xYYYYYYYY</code></ul><h2 id="homework"><a href="#homework">Homework</a></h2><h3 id="task-description">Task description:</h3><ul><li><strong>Step 1</strong>. Write a shellcode which prints out your name/nickname. Remove any NULL bytes and keep the shellcode as short as possible. To write the shellcode you basically only need to know how to use the write() and exit() syscalls<br /><li><strong>Step 2</strong>. Exploit the buffer overflow in the buffer.c program so that as a result, the shellcode you wrote in step 1 would get executed.</ul><p><strong>Vulnerable buffer.c program</strong><p><strong>Disable ASLR</strong>: <code class="highlighter-rouge">echo 0 | sudo tee /proc/sys/kernel/randomize_va_space</code><br /> <strong>Compile program</strong>: <code class="highlighter-rouge">gcc -fno-stack-protector -z execstack buffer.c -o buffer</code><p>buffer.c<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int foo(char *str)
{
    char buffer[100];
    printf("%p\n",buffer);
    strcpy(buffer, str);
    return 1;
}

int main(int argc, char **argv)
{
    char str[400];

    FILE *secretfile;
    secretfile = fopen("secretfile", "r");
    fread(str, sizeof(char), 300, secretfile);
    foo(str);
    printf("All good\n");
    return 1;
}
</code></pre></div></div><p><strong>Run the program</strong>: <code class="highlighter-rouge">./buffer</code><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./buffer
0x7fffffffdbb0
All good
</code></pre></div></div><h3 id="solution-path">Solution path</h3><p><strong>Step 1</strong>:<br /><ul><li>Shellcode, when run independently, should print out your name/nickname as follows:<br /><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./name
Silvia
</code></pre></div></div><li>Use <code class="highlighter-rouge">objdump -d -M intel &lt;filename&gt;</code> to verify that your shellcode does not have any NULL bytes<li><code class="highlighter-rouge">gethex &lt;filename&gt;</code> to dump the shellcode as a hex string, to use in the exploit in step 2</ul><p><strong>Step 2</strong>:<br /><ul><li>Use the dumped shellcode in your payload to exploit the vulnerable buffer.c program</ul><p>Rough bulletpoints what you should know to complete the task:<br /><ul><li>How is the user input consumed in the vulnerable program?<li>Vulnerability. Which buffer is overflown?<ul><li>Start address of that buffer?</ul><li><p>Address of the RIP to overwrite?<li>Vulnerable program “buffer” should produce the following output when run:<br /><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./buffer
0x7fffffffdbb0
Silvia
</code></pre></div></div></ul><p><strong>Step 3: Present your homework</strong><p><strong>Deadline (strict)</strong>: 01.12.2019, 23.59<br /> <strong>Send it to</strong>: &lt;silviavali14[at]gmail[dot]com&gt;<br /> <strong>Title of email</strong>: Student code, firstname lastname<br /><p>Email should contain:<br /><ul><li>Source code of the shellcode that prints out your name/nickname<li>Source code of exploit code used to complete step 2</ul><p>Rules !!!<br /><ol><li>Any homework that does not arrive in my mailbox by the set deadline is counted as not solved.<li>If you submit your homework multiple times, last one is the one that counts.<li>In order to complete the homework, both tasks (shellcode and buffer overflow exploitation) have to be done and sent to my e-mail. No points are given for half a solution. It either works and you get 10 points or it doesn’t and you get a 0.</ol></article><footer role="contentinfo"><hr/><p><small class="copyright">© 2019. All rights reserved. </small><p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">8.1.1</span></small><hr class="sr-only"/></footer></main><hy-drawer class="" align="left" threshold="10" touch-events prevent-default ><header id="_sidebar" class="sidebar" role="banner"><div class="sidebar-bg sidebar-overlay" style="background-color:rgb(25,55,71);background-image:url(/assets/img/sidebar-bg.jpg)"></div><div class="sidebar-sticky"><div class="sidebar-about"> <a class="no-hover" href="/" tabindex="-1"> <img src="/assets/img/profile.jpg" class="avatar" alt="Silvia's blog" data-ignore /> </a><h2 class="h1"><a href="/">Silvia's blog</a></h2><p class=""> Random notes or stuff I am curious about.</div><nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span><ul><li> <a id="_navigation" href="/blog/" class="sidebar-nav-item" > Blog </a><li> <a href="/about/" class="sidebar-nav-item" > About </a><li> <a href="/cheatsheet/" class="sidebar-nav-item active" > Notes for TalTech A&D course </a></ul></nav><div class="sidebar-social"> <span class="sr-only">Social:</span><ul><li> <a href="https://twitter.com/silviavaliSV" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a><li> <a href="https://github.com/silviavali" title="GitHub" class="no-mark-external"> <span class="icon-github"></span> <span class="sr-only">GitHub</span> </a></ul></div></div></header></hy-drawer><hr class="sr-only" hidden /> </hy-push-state> <!--[if !IE]><!----> <script>loadJSDeferred(document.getElementById('_hrefJS').href);</script> <!--<![endif]--> <script>!function(w, d) { w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date; /**/ ga('create', 'UA-137562580-1', 'auto'); /**/ var pushStateEl = d.getElementsByTagName('hy-push-state')[0]; var timeoutId; pushStateEl.addEventListener('hy-push-state-load', function() { w.clearTimeout(timeoutId); timeoutId = w.setTimeout(function() { ga('set', 'page', w.location.pathname); ga('send', 'pageview'); }, 500); }); d.addEventListener('hy--cookies-ok', function () { w.ga(function(tracker) { w.ga("set", "anonymizeIp", undefined); localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId")); }); }); w.loadJSDeferred('https://www.google-analytics.com/analytics.js'); }(window, document);</script> <script> if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistration() .then(r => r.unregister()) .catch(() => {}); } </script><h2 class="sr-only" hidden>Templates (for web app):</h2><template id="_animation-template" hidden><div class="animation-main fixed-top"><div class="content"><div class="page"></div></div></div></template> <template id="_loading-template" hidden><div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span></div></template> <template id="_error-template" hidden><div class="page"><h1 class="page-title">Error</h1><p class="lead"> Sorry, an error occurred while loading <a class="this-link" href=""></a>.</div></template> <template id="_back-template" hidden> <a id="_back" class="back nav-btn fl no-hover"> <span class="sr-only">Back</span> <span class="icon-arrow-left2"></span> </a> </template> <template id="_permalink-template" hidden> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="icon-link"></span> </a> </template></html>
